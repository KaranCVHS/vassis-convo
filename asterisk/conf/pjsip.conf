; =====================================================================================
; ASTERISK PJSIP CONFIGURATION FOR EC2 DEPLOYMENT
; =====================================================================================

;-------------------------------------------------------------------------------------
; TRANSPORT CONFIGURATION
; This defines how Asterisk communicates with the outside world.
;-------------------------------------------------------------------------------------
[transport-udp]
type=transport
protocol=udp
bind=0.0.0.0:5060  ; --- CORRECT: Listen on all interfaces 

; --- NAT SETTINGS ---
; These are now correctly linked to the environment variable from docker-compose
external_media_address=${EC2_PUBLIC_IP}
external_signaling_address=${EC2_PUBLIC_IP}

; This correctly identifies your internal Docker network.
local_net=172.20.0.0/24


;-------------------------------------------------------------------------------------
; ENDPOINT TEMPLATE
; This simplifies creating new endpoints with the correct NAT settings.
;-------------------------------------------------------------------------------------
[endpoint-template](!)
type=endpoint
transport=transport-udp   ; --- CORRECT: Using the UDP transport defined above
context=from-internal   ; --- BEST PRACTICE: Renamed context for clarity
disallow=all
allow=ulaw

; --- The Correct Modern NAT Settings ---
direct_media=no         ; Media must flow through Asterisk for the voicebot to work
force_rport=yes         ; Essential for NAT
rewrite_contact=yes     ; Essential for NAT
rtp_symmetric=yes       ; Essential for NAT


;-------------------------------------------------------------------------------------
; LOCAL EXTENSION (for a softphone like Zoiper, MicroSIP, etc.)
;-------------------------------------------------------------------------------------
[1000](endpoint-template) ; --- Uses the corrected template
aors=1000-aor
auth=1000-auth

[1000-auth]
type=auth
auth_type=userpass
password=1000
username=1000

[1000-aor]
type=aor
max_contacts=1


;-------------------------------------------------------------------------------------
; CHIME INBOUND TRUNK
; This handles incoming calls from AWS Chime PSTN Audio
;-------------------------------------------------------------------------------------
[chime-inbound](endpoint-template) ; --- CORRECT: Now uses the template to remove redundant code
context=from-chime               ; --- Overrides the context from the template

[chime-identify]
type=identify
endpoint=chime-inbound
match=3.80.16.0/23
match=3.235.127.128/26
match=52.55.62.0/24
match=52.55.63.0/24
match=172.20.0.1