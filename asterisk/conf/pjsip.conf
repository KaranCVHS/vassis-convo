


;-------------------------------------------------------------------------------------
; TRANSPORT CONFIGURATION
; This is the most important section for NAT
;-------------------------------------------------------------------------------------
[transport-tcp]
type=transport
protocol=tcp
bind=0.0.0.0:5060

; --- NAT SETTINGS ---
; IMPORTANT: Use the IP address of your ngrok tunnel, NOT the hostname.
external_signaling_address = 13.127.206.16
external_media_address = 13.127.206.16

; IMPORTANT: Use your Docker network range here. It's likely 172.20.0.0/16
local_net = 172.20.0.0/24


;-------------------------------------------------------------------------------------
; TEMPLATES
;-------------------------------------------------------------------------------------
[endpoint-template](!)
type=endpoint
transport=transport-tcp
context=demo
disallow=all
allow=ulaw
direct_media=no      ; Keep media flowing through Asterisk
force_rport=yes      ; Essential for NAT
rewrite_contact=yes  ; Essential for NAT
rtp_symmetric=yes    ; Essential for NAT
nat=yes              ; Essential for NAT


;-------------------------------------------------------------------------------------
; LOCAL EXTENSION (for MicroSIP, etc.)
; Corrected syntax with unique names
;-------------------------------------------------------------------------------------
[1000](endpoint-template)
aors=1000-aor
auth=1000-auth

[1000-auth]
type=auth
auth_type=userpass
password=1000
username=1000

[1000-aor]
type=aor
max_contacts=1


;-------------------------------------------------------------------------------------
; CHIME INBOUND TRUNK
; This handles incoming calls from AWS Chime
;-------------------------------------------------------------------------------------
[chime-inbound]
type=endpoint
transport=transport-tcp
context=from-chime
disallow=all
allow=ulaw
direct_media=no
force_rport=yes
rewrite_contact=yes
rtp_symmetric=yes
nat=yes

[chime-identify]
type=identify
endpoint=chime-inbound
match=52.55.62.0/24
match=52.55.63.0/24
match=3.80.16.0/23
match=3.235.127.128/26
match=172.20.0.1 ; Match the Docker gateway as well