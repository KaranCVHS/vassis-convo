; =====================================================================================
; ASTERISK DIALPLAN CONFIGURATION FOR EC2 DEPLOYMENT
; =====================================================================================

;-------------------------------------------------------------------------------------
; [avr] - Reusable subroutine to connect a call to the AudioSocket voice AI.
; It expects one argument: the URL of the backend service (e.g., 'avr-core:5001').
;-------------------------------------------------------------------------------------
[avr]
exten => s,1,Answer()
 same => n,NoOp(Starting AVR subroutine for backend: ${ARG1})
 same => n,Ringing()
 same => n,Wait(1)
 same => n,Set(UUID=${SHELL(uuidgen | tr -d '\n')}) ; Generate a unique ID for the session
 same => n,NoOp(AudioSocket session UUID is ${UUID})
 same => n,AudioSocket(${UUID},${ARG1})             ; Start the AudioSocket connection
 same => n,Dial(AudioSocket/${ARG1}/${UUID})        ; Bridge the caller to the AudioSocket
 same => n,Hangup()


;-------------------------------------------------------------------------------------
; [from-internal] - Handles calls from local SIP extensions (like extension 1000).
; This context should be assigned to your internal endpoints in pjsip.conf.
;-------------------------------------------------------------------------------------
[from-internal]
; Dialing 5001 connects the internal user directly to the voicebot.
exten => 5001,1,NoOp(Internal call from ${CALLERID(num)} to voicebot)
 same => n,GoSub(avr,s,1(avr-core:5001)) ; Correctly uses the Docker service name
 same => n,Hangup()


;-------------------------------------------------------------------------------------
; [from-chime] - Handles inbound calls from the AWS Chime PSTN service.
;-------------------------------------------------------------------------------------
[from-chime]
; _+X. matches any standard international phone number (E.164 format).
exten => _+X.,1,NoOp(Inbound call from PSTN number ${CALLERID(num)} to ${EXTEN})
 same => n,GoSub(avr,s,1(avr-core:5001)) ; Connects the external caller to the voicebot
 same => n,Hangup()